#!/bin/bash
################################################################################
#
# generate-documentation.sh
# 
# This script reads the two lists in this directory, my PLUGINS and third party
# ones. This script pulls the information from the plugin source files and
# creates updater manifests and the Readme. Take a look in PLUGINS for a better
# idea of how this works, note that dependencies and cvars are regenerated from
# scratch each run, so don't make any manual edits to those files.
# 
# (C) 2015, Jared Ballou <insurgency@jballou.com>
# Released under the GPLv2
#
################################################################################

#Files to update
SCRIPT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SOURCEMOD_PATH="$(dirname "${SCRIPT_PATH}")"

GITHUB_URL="https://github.com/jaredballou/insurgency-sourcemod/blob/master"
GITHUB_RAW_URL="https://raw.githubusercontent.com/jaredballou/insurgency-sourcemod/master"

PLUGINS_LIST="${SCRIPT_PATH}/plugins.jballou.txt"
PLUGINS=$(cat "${PLUGINS_LIST}")

TOC="${SCRIPT_PATH}/include/TOC.md"

UPDATE_PATH="${SOURCEMOD_PATH}/updater-data"
UPDATE_NEEDED=$(grep -o 'update-[^\.]\+\.txt' "${SOURCEMOD_PATH}/scripting"/*.sp)
UPDATE_CURRENT=$(ls "${UPDATE_PATH}"/*.txt)
UPDATE_URLBASE="http://ins.jballou.com/sourcemod"

LIBRARY_IGNORE="updater"
function add_file_to_update() {
	FILETYPE="${1}"
	FILEPATH="Path_SM/${2}"
	if [ $(grep -c -i "\"${FILETYPE}\"[^\"]*\"${FILEPATH}\"" "${UPDATE}") -eq 0 ]
	then
		echo "Adding ${FILETYPE} ${FILEPATH} to updater"
	fi
}
#Loop through all files
echo > "${TOC}"
for ITEM in $PLUGINS
do
	echo "Processing ${ITEM}"

	#Get base plugin name and source script
	PLUGIN="plugins/${ITEM}.smx"
	
	SCRIPT="scripting/${ITEM}.sp"
	UPDATE="${UPDATE_PATH}/update-${ITEM}.txt"

	# Create updater file if missing
	if [ ! -e "${UPDATE}" ]
	then
		echo "Creating update-${ITEM}.txt in updater-data..."
		cp "${UPDATE_PATH}/_template.txt" "${UPDATE}"
	fi

	# These are lists of the items that we need to put into the updater
	add_file_to_update "Plugin" "plugins/${ITEM}.smx"
	add_file_to_update "Source" "scripting/${ITEM}.sp"

	# Create description and todo files if they do not exist
	if [ ! -e "${SCRIPT_PATH}/plugins/description/${ITEM}.md" ]; then touch "${SCRIPT_PATH}/plugins/description/${ITEM}.md"; fi
	if [ ! -e "${SCRIPT_PATH}/plugins/todo/${ITEM}.md" ]; then touch "${SCRIPT_PATH}/plugins/todo/${ITEM}.md"; fi

	# Collect CVARs
	grep CreateConVar "${SCRIPT}" | grep -v '_version"' | sed -e 's/""/NULLSTRING/g' | awk -F'"' -v OFS='' '{ for (i=2; i<=NF; i+=2) gsub(",", ";;", $i) } 1' | cut -d'(' -f2 | sed -e 's/"//g' | awk -F',' '{print $1" "$2" "$3}' | sed -e 's/;;/,/g' | awk '{printf " * \""$1"\" \""$2"\" //"$3;for(i=4;i<=NF;i++){printf " %s", $i}printf "\n"}' | sed -e 's/NULLSTRING//g' > "${SCRIPT_PATH}/plugins/cvar/${ITEM}.md"

	# Colelct dependencies
	echo -ne > "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
	INCLUDES=$(grep -o '^#include <[^>]\+' "${SCRIPT}" | cut -d'<' -f2)
	for INC in $INCLUDES
	do
		if [ $(grep "^$(basename "${INC}")\$" "${PLUGINS_LIST}" -c) -gt 0 ]
		then
			echo " * [Source Include - ${INC}.inc](${GITHUB_RAW_URL}/scripting/include/${INC}.inc)" >> "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
			add_file_to_update "Source" "scripting/include/${INC}.inc"
		fi
	done
	for CFGFILE in $(grep -Po 'LoadGameConfigFile\([^\)]+\)' "${SCRIPT}" | cut -d'"' -f2)
	do
		echo " * [gamedata/${CFGFILE}.txt](${GITHUB_RAW_URL}/gamedata/${CFGFILE}.txt)" >> "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
		add_file_to_update "Plugin" "gamedata/${CFGFILE}.txt"
	done
	for TRANSFILE in $(grep -Po 'LoadTranslations\([^\)]+\)' "${SCRIPT}" | cut -d'"' -f2)
	do
		echo " * [translations/${TRANSFILE}.txt](${GITHUB_RAW_URL}/translations/${TRANSFILE}.txt)" >> "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
		add_file_to_update "Plugin" "translations/${TRANSFILE}.txt"
	done
	for LIBRARY in $(grep -Po 'LibraryExists\([^\)]+\)' "${SCRIPT}" | cut -d'"' -f2)
	do
		if [ "$(grep "${LIBRARY}" "${SCRIPT_PATH}/plugins.jballou.txt")" == "${LIBRARY}" ]
		then
			echo " * [Plugin - ${LIBRARY}](#${LIBRARY})" >> "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
		else
			# TODO: Make this use the LIBRARY_IGNORE variable, for now just ignore updater
			if [ "${LIBRARY}" != "updater" ]
			then
				echo " * [Third-Party Plugin: ${LIBRARY}](PLUGINS/${LIBRARY}.smx?raw=true)" >> "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md"
			fi
		fi
	done

        CURURL=$(grep -i '^#define.*UPDATE_URL' "${SCRIPT}" | cut -d'"' -f2)
	NEWURL="${UPDATE_URLBASE}/update-${ITEM}.txt"

	CURVER=$(grep '"Latest".*"[0-9\.]*"' "${UPDATE}" | cut -d'"' -f4)
	NEWVER=$(grep -i '^#define.*_version' "${SCRIPT}" | cut -d'"' -f2)
        NEWNAME=$(grep -i '^#define.*PLUGIN_NAME' "${SCRIPT}" | cut -d'"' -f2)
        if [ "${NEWNAME}" == "" ]
        then
                NEWNAME=$(grep -m1 -P '^[\s]*name[\s]*=.*"' "${SCRIPT}" | cut -d'"' -f2)
        fi
	NEWNAME=$(echo "${NEWNAME}" | sed -e 's/\[INS\] //')
        NEWDESC=$(grep -i '^#define.*PLUGIN_DESCRIPTION' "${SCRIPT}" | cut -d'"' -f2)
        if [ "${NEWDESC}" == "" ]
        then
                NEWDESC=$(grep -m1 -P '^[\s]*description[\s]*=.*"' "${SCRIPT}" | cut -d'"' -f2)
        fi

	CURNOTES=$(grep -m1 -i '"Notes".*"' "${UPDATE}" | cut -d'"' -f4|sed -e 's/[]\/$*.^|[]/\\&/g')
	NEWNOTES=$(echo "${NEWNAME} - ${NEWDESC}" | sed -e 's/[]\/$*.^|[]/\\&/g')

        NEWTITLE="${NEWNAME} ${NEWVER}"
        NEWHREF=$(echo "${NEWTITLE}" | sed -e 's/ /-/g' -e 's/[^a-zA-Z0-9-]//g')

	# Update updater manifests
	if [ "${CURURL}" != "${NEWURL}" ]
	then
		echo "Changing ${ITEM} UPDATE_URL from \"${CURURL}\" to \"${NEWURL}\""
		sed -e "s,${CURURL},${NEWURL}," -i "${SCRIPT}"
	fi

	#Update Name in update file
	if [ "${CURNOTES}" != "${NEWNOTES}" ]
	then
		echo "Changing ${ITEM} Title Note from \"${CURNOTES}\" to \"${NEWNOTES}\""
		sed -e "s\`${CURNOTES}\`${NEWNOTES}\`" -i "${UPDATE}"
	fi

	#Update Version in update file
	if [ "${CURVER}" != "${NEWVER}" ]
	then
		echo "Bumping ${ITEM} from ${CURVER} to ${NEWVER}"
		sed -e "s/${CURVER}/${NEWVER}/" -i "${UPDATE}"
	fi

	# Update plugin documentation for readme
	echo -e " * <a href='#${ITEM}'>${NEWNAME} ${NEWVER}</a>" >> "${TOC}"

	echo -e "---\n<a name='${ITEM}'>### ${NEWTITLE}</a>" > "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo "${NEWDESC}" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo " * [Plugin - ${ITEM}.smx](PLUGINS/${ITEM}.smx?raw=true)" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo " * [Source - ${ITEM}.sp](${GITHUB_RAW_URL}/scripting/${ITEM}.sp)" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	cat "${SCRIPT_PATH}/plugins/description/${ITEM}.md" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	if [ $(wc "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md" | awk '{print $2}') -gt 0 ]
	then
		echo "#### Dependencies" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		cat "${SCRIPT_PATH}/plugins/dependencies/${ITEM}.md" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	fi
	if [ $(wc "${SCRIPT_PATH}/plugins/cvar/${ITEM}.md" | awk '{print $2}') -gt 0 ]
	then
		echo "#### CVAR List" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		cat "${SCRIPT_PATH}/plugins/cvar/${ITEM}.md" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	fi
	if [ $(wc "${SCRIPT_PATH}/plugins/todo/${ITEM}.md" | awk '{print $2}') -gt 0 ]
	then
		echo "#### Todo" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		cat "${SCRIPT_PATH}/plugins/todo/${ITEM}.md" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
		echo "" >> "${SCRIPT_PATH}/plugins/${ITEM}.md"
	fi
done
echo >> "${TOC}"
cat "${SCRIPT_PATH}/include/HEADER.md" "${SCRIPT_PATH}/include/TOC.md" "${SCRIPT_PATH}/plugins/"*.md "${SCRIPT_PATH}/include/FOOTER.md" > "${SOURCEMOD_PATH}/README.md"

git add *
